{
  "name": "kristina_dubai",
  "nodes": [
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4.1-mini",
          "mode": "list",
          "cachedResultName": "gpt-4.1-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -2096,
        1040
      ],
      "id": "96a5f494-7d66-4745-9ae4-e2cad6a76fc0",
      "name": "OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "kxH60aJwWWGZzBaI",
          "name": "Gosha GPT Key"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0312def6-af7b-49a7-bf78-0ba01ca99b5e",
              "leftValue": "={{ $('Parse to JSON').first().json.qualification_done }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -784,
        1088
      ],
      "id": "bf955dde-0769-430c-97b5-79da31bafba7",
      "name": "Client Qualified"
    },
    {
      "parameters": {
        "url": "={{ $('ENV Variables').first().json.is_test \n  ? $('ENV Variables').first().json.supabase_clients_url_test\n  : $('ENV Variables').first().json.supabase_clients_url\n}}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "phone_number",
              "value": "=eq.{{ $('Client Metadata').first().json.phone_number }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4256,
        800
      ],
      "id": "93f04b0a-4cd4-4082-847c-99da09e1c9c2",
      "name": "Get Client",
      "alwaysOutputData": true,
      "credentials": {
        "httpHeaderAuth": {
          "id": "FAFnBfYyqTLXDpjY",
          "name": "Kristina Dubai Supabase Auth Account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ Object.keys($json).length }}",
                    "rightValue": 0,
                    "operator": {
                      "type": "number",
                      "operation": "equals"
                    },
                    "id": "f47b8f45-be65-48ea-a9c4-32d250b1a71d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Does not exist"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "a69fb4bc-80d1-4fd6-8ecb-ba0087194139",
                    "leftValue": "={{ $json.qualification_done }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "false",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Not Qualified"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b5cbc6f9-d96d-4b84-9305-8736cc7d1226",
                    "leftValue": "={{ $json.qualification_done }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Qualified"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -4048,
        784
      ],
      "id": "17fb5da5-9761-4416-93f7-2d39bb7f140f",
      "name": "Check Client"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ENV Variables').first().json.is_test \n  ? $('ENV Variables').first().json.supabase_clients_url_test\n  : $('ENV Variables').first().json.supabase_clients_url\n}}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"phone_number\": \"{{ $('Client Metadata').first().json.phone_number }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3840,
        672
      ],
      "id": "ed56729c-235b-4c71-aece-4b23abb61585",
      "name": "Create Client",
      "credentials": {
        "httpHeaderAuth": {
          "id": "FAFnBfYyqTLXDpjY",
          "name": "Kristina Dubai Supabase Auth Account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6ee4a9d0-cd05-49a4-8883-3f7a589d4dfc",
              "name": "id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "8f1b83db-edcd-4161-b3ac-3252c3de9834",
              "name": "phone_number",
              "value": "={{ $json.phone_number }}",
              "type": "string"
            },
            {
              "id": "5562e645-8076-4c52-a9a9-0ccc8329e999",
              "name": "message",
              "value": "={{ $('Client Metadata').first().json.message }}",
              "type": "string"
            },
            {
              "id": "f32b020e-22e5-4265-9426-e74babf6b38c",
              "name": "timestamp",
              "value": "={{ $('Client Metadata').first().json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3648,
        800
      ],
      "id": "006ad1cd-6253-480d-a682-0da3183773cd",
      "name": "Client Data"
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "={{ $('ENV Variables').first().json.is_test \n  ? $('ENV Variables').first().json.supabase_clients_url_test\n  : $('ENV Variables').first().json.supabase_clients_url\n}}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "id",
              "value": "=eq.{{ $('Client Data').first().json.id }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n{{ ($json.qualification_done ? '\"qualification_done\": true,' : '') }}\n  \"last_message_at\": \"{{ $now.toISO() }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1312,
        576
      ],
      "id": "d7c993a1-94f0-4185-9ee1-a79e56d4c116",
      "name": "Update Client",
      "credentials": {
        "httpHeaderAuth": {
          "id": "FAFnBfYyqTLXDpjY",
          "name": "Kristina Dubai Supabase Auth Account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ENV Variables').first().json.upstash_base_url }}/pipeline",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "=[\n  [\"rpush\", \"chat-buffer-{{ $('Client Data').first().json.phone_number }}\", {{ JSON.stringify($json.message) }}],\n  [\"expire\", \"chat-buffer-{{ $('Client Data').first().json.phone_number }}\", \"{{ $('ENV Variables').first().json.upstash_messages_stack_ttl ?? 30 }}\"]\n]\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3248,
        640
      ],
      "id": "31382ff9-642e-4f32-902d-f5efd606dbd8",
      "name": "Add to Messages Stack",
      "credentials": {
        "httpHeaderAuth": {
          "id": "BfV7pnbm9L2uaLya",
          "name": "Upstash Account"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $('ENV Variables').first().json.upstash_base_url }}/lrange/chat-buffer-{{ $('Client Data').first().json.phone_number }}/0/-1",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3072,
        800
      ],
      "id": "7b44d429-5f91-4c73-a683-d5ccc90abf63",
      "name": "Get Latest Message Stack",
      "credentials": {
        "httpHeaderAuth": {
          "id": "BfV7pnbm9L2uaLya",
          "name": "Upstash Account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "f0746901-e813-4eab-a3c8-7b43368c4400",
              "leftValue": "={{ $('Get Latest Message Stack').first().json.result.length === 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            },
            {
              "id": "ec39573f-f92a-4fe4-a832-0a137de8e7d0",
              "operator": {
                "type": "string",
                "operation": "equals"
              },
              "leftValue": "={{ $('Get Latest Message Stack').first().json.result.last() }}",
              "rightValue": "={{ $('Client Data').first().json.message }}"
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "532bcc27-39a2-4ad1-8da8-2497e4854ac9",
      "name": "Should Continue?",
      "type": "n8n-nodes-base.if",
      "position": [
        -2896,
        800
      ],
      "typeVersion": 2
    },
    {
      "parameters": {
        "content": "## Retrieve Client data from Supabase\n* Get client by phone number\n* Create if not exists, end workflow if qualified\n* Form 'Client Data' node for easy access to essential data ",
        "height": 624,
        "width": 816,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -4288,
        576
      ],
      "typeVersion": 1,
      "id": "74bb3553-968c-49ea-8717-1b7440d010a8",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f2a84784-9164-4815-9395-0eefc8398f28",
              "leftValue": "={{ $('Message Received').first().json.body.data.meta.isGroup }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            },
            {
              "id": "2acf4a18-4088-4293-ba22-b0983a02e7b5",
              "leftValue": "={{ $('Message Received').first().json.body.data.fromNumber }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "53821d8b-d218-4f16-ad63-ffb2aef08960",
              "leftValue": "={{ $('Message Received').first().json.body.data.body }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4720,
        880
      ],
      "id": "203efdeb-898c-4622-8ddd-bcacdd426fdc",
      "name": "Valid?",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "var messageStack = $('Get Latest Message Stack').first().json.result\n\nreturn [\n    { \n      json: { \n        text: messageStack.join('. ') \n      } \n    }\n  ]"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2496,
        800
      ],
      "id": "61a642d3-3750-4631-9c60-965ac6a7eba9",
      "name": "Get Messages Buffer"
    },
    {
      "parameters": {
        "content": "## Handle many messages in a row\nStagger an AI Agent's reply if users often send in a sequence of partial messages and in short bursts.\n\n* Webhook's message is recorded in a message stack powered by Redis.\n* The execution is immediately paused for 15 seconds and then another check is done against the message stack for the latest message.\n* The purpose of this check lets use know if the user is sending more messages or if they are waiting for a reply.\n* The execution is aborted if the latest message on the stack differs from the incoming message and continues if they are the same.\n* For the latter, the agent receives buffered messages and is able to respond to all in a single reply.",
        "height": 800,
        "width": 1104,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -3392,
        432
      ],
      "typeVersion": 1,
      "id": "a8643116-db44-4915-b43f-acb0288ac0f8",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "jsCode": "const formatForWhatsApp = (\n  {\n    state_user_role, \n    state_payment_method, \n    state_building_familiarity, \n    state_client_intent, \n    summary\n  }, \n  phone_number\n) => {\n  return `1. *Client Type*: ${capitalize(state_user_role)}\\n` +\n         `2. *Payment*: ${capitalize(state_payment_method)}\\n` +\n         `3. *Knows The Property*: ${capitalizeYesNo(state_building_familiarity)}\\n` +\n         `4. *Intent*: ${capitalize(state_client_intent)}\\n` +\n         `5. *Summary*: ${summary}\\n` +\n         `6. *Chat*: https://wa.me/${phone_number}`\n}\n\nconst capitalize = str => !str ? 'â€”' : str.charAt(0).toUpperCase() + str.slice(1)\nconst capitalizeYesNo = str => str === 'Yes' ? 'Yes' : str === 'No' ? 'No' : capitalize(str)\n\nconst ai = $('Parse to JSON').first().json\nconst phone = $('Client Data').first().json.phone_number\n\nconst message = formatForWhatsApp(ai, phone)\n\nreturn [{ message }]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        1152
      ],
      "id": "269fae3b-5651-468d-a6ab-16c9ab864e93",
      "name": "Create Qualification Message"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -784,
        1248
      ],
      "id": "77399f94-b855-454d-8036-36330133f71d",
      "name": "No Operation, do nothing3"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Get Messages Buffer').first().json.text }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "=You are an expert Real Estate Intake Specialist. Your sole purpose is to qualify incoming leads effectively, professionally, and efficiently. You must strictly follow a logical decision tree to categorize the user.\n\nðŸ“Œ OUTPUT FORMAT (CRITICAL)\nYou must ONLY output exactly one valid JSON object. Do not output any conversational text outside the JSON block.\nYour response must follow this schema:\n{\n  \"message\": \"String (The text reply to the client)\",\n  \"qualification_done\": boolean,\n  \"state\": {\n    \"user_role\": \"Self\" | \"Agent\" | null,\n    \"building_familiarity\": \"Yes\" | \"No\" | null,\n    \"payment_method\": \"Cash\" | \"Mortgage\" | null,\n    \"pre_approved\": \"Yes\" | \"No\" | null,\n    \"client_intent\": \"Investor\" | \"Self-Use\" | null,\n    \"off_topic_count\": integer (0 or 1)\n  },\n  \"summary\": \"String (Brief summary of collected data, only if qualification_done is true, otherwise null)\",\n  \"off_topic_redirect\": boolean (true ONLY if you are redirecting a distraction)\n}\n\nðŸ“Œ CONVERSATION FLOW (STRICT)\nSTEP 1: \n  - Action: Start with a brief greeting (\"Hello.\") followed by the question: Are you looking for a property for yourself or are you an agent representing a client?\n  - Logic:\n    - If Agent: Set user_role = Agent. SKIP to STEP 3.\n    - If Self: Set user_role = Self. PROCEED to STEP 2.\n\nSTEP 2: Building Familiarity (Self Only)\n  - Action: Ask if they are familiar with the building.\n  - Logic:\n    - If Familiar: Set building_familiarity = Yes. PROCEED to STEP 3.\n    - If Not Familiar: Set building_familiarity = No. You must reply with SCRIPT A, then immediately append the question from STEP 3 in the same message string.\n\nSTEP 3: Payment Method\n  - Action: Ask if they (or their client) intend to pay via cash or mortgage.\n  - Logic:\n    - If user_role == Agent, adjust script to ask \"Is your client intending to pay via cash or mortgage?\"\n    - If mortgage: Set payment_method = Mortgage. PROCEED to STEP 4.\n    - If cash: Set payment_method = Cash.\n      - If user_role == Self: JUMP to STEP 7.\n      - If user_role == Agent: PROCEED to STEP 3.1.\n\nSTEP 3.1: Client Intent (Agent + Cash Only)\n  - Action: Ask if their client is an investor or looking to live in the property themselves.\n  - Logic:\n    -Once answered: Set client_intent variable. JUMP to STEP 7.\n\nSTEP 4: Pre-Approval (Mortgage Only)\n  - Action: Ask if they (or their client) have been pre-approved by a bank.\n  - Logic:\n    - If Yes: Set pre_approved = Yes. PROCEED to STEP 5.\n    - If No: Set pre_approved = No. JUMP to STEP 7.\n\nSTEP 5: Mortgage Education\n  - Action: Inform them about the limits using SCRIPT B. Ask if this works for them.\n  - Logic:\n    - Wait for the userâ€™s acknowledgment (Yes/No/Maybe). \n    - Once received: PROCEED to STEP 7.\n\nSTEP 7: Closing & Handoff\n  - Action: Mark qualification as complete (qualification_done = true).\n  - Logic:\n    - If user_role == Self: Reply exactly with SCRIPT C.\n    - If user_role == Agent: Reply exactly with SCRIPT D.\n\nðŸ“Œ MANDATORY SCRIPTS (VERBATIM)\nYou must use these exact phrases in the JSON message field when triggered.\n\nSCRIPT A (Step 2 - Not Familiar):\n\"No problem - Iâ€™ll send you the full presentation shortly.\"\n(Note: Immediately append the question about cash vs. mortgage).\n\nSCRIPT B (Step 5 - Mortgage Limits):\n\"Just so you know - mortgages for off-plan properties typically cover only around 50% of the value - the rest must be paid upfront. Would that work for you?\"\n(Note: Change \"for you\" to \"for your client\" if user_role == Agent).\n\nSCRIPT C (Step 7 - Closing for Self):\n\"Let me double-check a few things and Iâ€™ll get back to you shortly.\"\n\nSCRIPT D (Step 7 - Closing for Agent):\n\"Got it. Iâ€™ll double-check a couple of details, but meanwhile take a look at my property list below. Maybe something works for your other clients. Viewings anytime.\"\n\nðŸ“Œ STYLE AND LANGUAGE CONTROL\n- Do NOT use polite softening phrases such as â€œmay Iâ€, â€œcould youâ€, â€œwould youâ€, â€œpleaseâ€, â€œlet me knowâ€, â€œkindlyâ€, â€œif you donâ€™t mindâ€, or similar forms.\n- Avoid unnecessary courtesy.\n- Very short replies.\n- No enthusiasm or filler expressions.\n- Neutral, calm, business-like tone.\n- Use feminine form and pronouns in self-reference.\n- Do not use the word â€œqualificationâ€ in your replies (internal term only).\n- Always send \"message\" in the userâ€™s language, regardless of the source language of mandatory scripts. If a mandatory script is provided in English, translate it into the userâ€™s language while preserving exact meaning and tone.\n\nðŸ“Œ RESILIENCE & JSON HANDLING guidelines\n1. State Tracking: Always output the current known state in the state object. If a field is unknown, keep it null.\n2. Handling Off-Topic Replies (Strict):\n  - Availability: If asked about property availability, confirm it is available, then immediately continue with the last unanswered question.\n  - Distractions:\n    - First Attempt: Reply: \"I'll provide all those details shortly,\" and repeat your pending question. Set off_topic_redirect: true and off_topic_count: 1 in the JSON.\n    - Second Attempt: If off_topic_count is 1 and they derail again, stop the process immediately. Set qualification_done: true and reply with Step 7.\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        -2000,
        800
      ],
      "id": "a2eb1e4b-fe48-4b69-9519-2a3d67764787",
      "name": "AI Agent",
      "alwaysOutputData": false,
      "retryOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "43530d47-21b2-4325-a425-0e267c23c97d",
              "name": "is_test",
              "value": "={{ $json.is_test }}",
              "type": "boolean"
            },
            {
              "id": "3a0f2b30-a97d-43a1-b9d0-29288a27b71e",
              "name": "supabase_clients_url",
              "value": "https://fybqwzsdoqcucdtxhlla.supabase.co/rest/v1/clients",
              "type": "string"
            },
            {
              "id": "8ad6d322-69fe-41fe-8ac4-7f7110579e45",
              "name": "supabase_messages_url",
              "value": "https://fybqwzsdoqcucdtxhlla.supabase.co/rest/v1/chat_messages",
              "type": "string"
            },
            {
              "id": "629ef0c0-bdcb-4167-a636-c3c830d8f45c",
              "name": "supabase_clients_url_test",
              "value": "https://fybqwzsdoqcucdtxhlla.supabase.co/rest/v1/test_clients",
              "type": "string"
            },
            {
              "id": "da119127-6ac5-480a-92d5-e92acebffbbb",
              "name": "supabase_messages_url_test",
              "value": "https://fybqwzsdoqcucdtxhlla.supabase.co/rest/v1/test_messages",
              "type": "string"
            },
            {
              "id": "fa179b5b-c758-4254-828b-1335133b64a4",
              "name": "upstash_base_url",
              "value": "=https://intent-guinea-6714.upstash.io",
              "type": "string"
            },
            {
              "id": "109ed271-74b2-4036-b38e-708700bc2e45",
              "name": "upstash_messages_stack_ttl",
              "value": "={{ $json.is_test ? 10 : 115 }}",
              "type": "string"
            },
            {
              "id": "5b9b6c90-0dae-47e6-9803-4c14782beb02",
              "name": "manager_group_id",
              "value": "120363419887584150@g.us",
              "type": "string"
            },
            {
              "id": "7deca1f1-923c-423f-88dd-a3715e3cd72b",
              "name": "manager_phone",
              "value": "=971585609763",
              "type": "string"
            },
            {
              "id": "4aad1a28-781b-4040-beff-47e03a34d8dd",
              "name": "wasender_api_key",
              "value": "={{ $json.is_test ? 'Bearer a1ce08457c8ae054d4ff2849f61141ad3af71639a1663825a5fa1bb4c7bd3a0a' : 'Bearer 31f80b7c5666626556ae8960357445868e2bc15b8530c964663e7cf8565e618c' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5392,
        784
      ],
      "id": "982d6815-fbfc-4162-b34a-a6fa15385e4d",
      "name": "ENV Variables"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -3984,
        992
      ],
      "id": "afc38b11-33e8-4258-a3e3-872baf76f5d1",
      "name": "Client Is Already Qualified"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -4528,
        944
      ],
      "id": "4871d436-a743-481a-8d24-a18e992771da",
      "name": "Invalid input data"
    },
    {
      "parameters": {
        "content": "## Setting up test environment\n1. Disable \"WasenderAPI Message\" mode\n2. Enable \"WasenderAPI Test Message\" node\n3. DONE",
        "height": 192,
        "width": 416,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -8128,
        672
      ],
      "typeVersion": 1,
      "id": "83e2b190-4aac-4f10-a4e3-98a1cb983090",
      "name": "Sticky Note2"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2864,
        976
      ],
      "id": "a814068b-6ea4-4253-8b8e-160db38a6e5d",
      "name": "Client sent another message, stop execution"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a0805f38-0e68-48c5-88d9-5759c8e4863d",
              "leftValue": "={{ $('ENV Variables').first().json.is_test }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5088,
        784
      ],
      "id": "f9208a2a-a0a6-4903-82dc-92f370dad55b",
      "name": "Is Test?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a0805f38-0e68-48c5-88d9-5759c8e4863d",
              "leftValue": "={{ $('ENV Variables').first().json.is_test }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1248,
        784
      ],
      "id": "bbf4a436-63a2-474c-9032-836d8cbff70a",
      "name": "Is Test?1"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "916e2b7f-bb9e-4018-8d3f-1c83b4eff89d",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -6496,
        176
      ],
      "id": "c945ecae-eafe-4e62-85bb-a54df8f7862a",
      "name": "Message Received",
      "webhookId": "916e2b7f-bb9e-4018-8d3f-1c83b4eff89d",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8833cfc3-9dda-4940-8582-145f55d7d572",
              "leftValue": "={{ $('Message Received').first().json.body.data.fromNumber }}",
              "rightValue": "998934621498",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6272,
        176
      ],
      "id": "8ed07177-3886-4b23-a787-e9aed4a56e65",
      "name": "Prod test If"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8833cfc3-9dda-4940-8582-145f55d7d572",
              "leftValue": "={{ $('Message Received').first().json.body.data.fromNumber.replace(/^\\+/, '') }}",
              "rightValue": "998934621498",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "bc7fd94a-a78e-4456-9ce2-4ff73d7c1716",
              "leftValue": "={{ $('Message Received').first().json.body.data.fromNumber.replace(/^\\+/, '') }}",
              "rightValue": "380963236071",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6096,
        176
      ],
      "id": "2e6b983d-1743-4b06-86a7-79eff521b002",
      "name": "Prod test If1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f963525b-bfcb-4c42-8579-50155ff81786",
              "leftValue": "={{ $json.keys().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1520,
        800
      ],
      "id": "eaec0392-fd58-483c-ae9f-49d1e3ac4a59",
      "name": "Output Not Empty?"
    },
    {
      "parameters": {
        "content": "## VERSION\n1. Create a copy of workflow\n2. Add changes there\n3. Test using test env\n4. **Set Webhook's route**\n5. Disable previous workflow\n6. Enable new version",
        "height": 224,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -8464,
        672
      ],
      "typeVersion": 1,
      "id": "6d58271c-5047-4f89-823f-a74651f918e6",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "amount": "={{ $('ENV Variables').first().json.is_test ? 5 : 110 }}"
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -3248,
        800
      ],
      "id": "6b4eb837-f677-4467-8277-6ce06893ff3e",
      "name": "Wait 100 seconds",
      "webhookId": "7211da6a-d6cb-4d93-8bc2-0e7e6e9997f7"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8cb89a6a-240b-48fe-8d54-a47243fec2e0",
              "leftValue": "={{ $('Gupsup Message').first().json.body.entry[0].changes[0].value.contacts[0].wa_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "71243fb1-7d37-4214-bb31-55956adeda22",
              "leftValue": "={{ $('Gupsup Message').first().json.body.entry[0].changes[0].value.messages[0].text.body }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6912,
        176
      ],
      "id": "f4ac2577-4e56-4289-8a0f-965fde421f13",
      "name": "Valid Gupshup Message?"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "d7bb1f08-8e6d-4ac6-b6ec-0fca2715c459",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -7088,
        176
      ],
      "id": "e5946699-2e80-46c8-a539-e880edf35dd8",
      "name": "Gupsup Message",
      "webhookId": "d7bb1f08-8e6d-4ac6-b6ec-0fca2715c459",
      "disabled": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "30c74198-3cb5-4608-a8d5-a86e5533b67b",
              "name": "phone_number",
              "value": "={{ $('Gupsup Message').first().json.body.entry[0].changes[0].value.contacts[0].wa_id }}",
              "type": "string"
            },
            {
              "id": "91b4f2ff-31ea-49bc-b034-196bcc1acfb4",
              "name": "message",
              "value": "={{ $('Gupsup Message').first().json.body.entry[0].changes[0].value.messages[0].text.body }}",
              "type": "string"
            },
            {
              "id": "d504bba8-abb0-4a2d-8bc6-f3bfdc104673",
              "name": "timestamp",
              "value": "={{ $('Gupsup Message').first().json.body.entry[0].changes[0].value.messages[0].timestamp }}",
              "type": "string"
            },
            {
              "id": "9427b9d1-e7fc-447f-9aad-f49dd007b260",
              "name": "is_group",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "ff36c1fd-831c-482e-b9ef-88d1bd68c732",
              "name": "group_id",
              "value": "",
              "type": "string"
            },
            {
              "id": "baff30d2-9a74-4dfc-b80e-b4807538dc80",
              "name": "is_test",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6736,
        176
      ],
      "id": "9be55ee6-7196-44d7-a4b7-bd8c978a9d61",
      "name": "Gupshup Metadata"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2acf4a18-4088-4293-ba22-b0983a02e7b5",
              "leftValue": "={{ \n  $json.body.data.messages.remoteJid.match(/^(\\+?\\d+)(@s\\.whatsapp\\.net)$/)\n  ?? $json.body.data.messages.remoteJid.match(/^\\d+@g\\.us$/)\n  ?? $json.body.data.messages.remoteJid.match(/^(\\+?\\d+)(@lid)$/)\n  ?? [] \n}}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6640,
        784
      ],
      "id": "f121a52d-f5d4-464b-9bea-1735900d38e9",
      "name": "Valid Wassenger Message?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8f1b83db-edcd-4161-b3ac-3252c3de9834",
              "name": "phone_number",
              "value": "={{ (() => {\n  const cleanedSenderPn = $('Message').first().json.body.data.messages.key.cleanedSenderPn;\n  const jid = $('Message').first().json.body.data.messages.remoteJid;\n  const m = jid.match(/^(\\+?\\d+)(@s\\.whatsapp\\.net|@lid)$/);\n  if (!m) return null;\n\n  const res = m[2] === '@lid' ? m[1] + m[2] : m[1];\n// those are already stored in supabase with @lid format\n  const exceptions = ['167877957148828@lid', '144684596883503@lid', '145217760030909@lid', '56595102843067@lid'];\n\n  if (!cleanedSenderPn || exceptions.includes(res)) {\n    return res;\n  }\n\n  return cleanedSenderPn;\n})() }}",
              "type": "string"
            },
            {
              "id": "5562e645-8076-4c52-a9a9-0ccc8329e999",
              "name": "message",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "f32b020e-22e5-4265-9426-e74babf6b38c",
              "name": "timestamp",
              "value": "={{ $('Message').first().json.body.data.messages.messageTimestamp }}",
              "type": "string"
            },
            {
              "id": "2faa1796-dbed-46b5-b1ff-2383184d9c2c",
              "name": "is_group",
              "value": "={{ !!$('Message').first().json.body.data.messages.remoteJid.match(/^\\d+@g\\.us$/) ?? false }}",
              "type": "boolean"
            },
            {
              "id": "9483a99d-5f99-4dec-b0b8-a3d937a0949f",
              "name": "group_id",
              "value": "={{ (() => {\n    const m = $('Message').first().json.body.data.messages.remoteJid.match(/^\\d+@g\\.us$/)\n    return m ? m[0] : null\n  })()  }}",
              "type": "string"
            },
            {
              "id": "d3f0c653-afd2-421f-b96d-e5beb81b938f",
              "name": "is_test",
              "value": "={{ $('Message').first().json.webhookUrl && $('Message').first().json.webhookUrl.includes('test') }}",
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5904,
        784
      ],
      "id": "f0875cba-8a72-4672-8a0f-025330b6eb83",
      "name": "Wassenger Metadata"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "kristina_dubai",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -7024,
        896
      ],
      "id": "3a819aaf-0bf4-4009-a2b6-72479e6d8453",
      "name": "WasenderAPI Message",
      "webhookId": "d6a1994a-f99c-4145-b776-e52cb3183b06"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "30c74198-3cb5-4608-a8d5-a86e5533b67b",
              "name": "phone_number",
              "value": "={{ $json.phone_number }}",
              "type": "string"
            },
            {
              "id": "91b4f2ff-31ea-49bc-b034-196bcc1acfb4",
              "name": "message",
              "value": "={{ $json.message }}",
              "type": "string"
            },
            {
              "id": "d504bba8-abb0-4a2d-8bc6-f3bfdc104673",
              "name": "timestamp",
              "value": "={{ $json.timestamp }}",
              "type": "string"
            },
            {
              "id": "e3c16359-3a83-4c3b-b281-8335666605c8",
              "name": "is_group",
              "value": "={{ $json.is_group }}",
              "type": "boolean"
            },
            {
              "id": "e4c81f87-f693-4053-992d-49fb5004f70d",
              "name": "group_id",
              "value": "={{ $json.group_id }}",
              "type": "string"
            },
            {
              "id": "bc388183-3727-4fb1-a2a0-5c5b9ebfbce9",
              "name": "=is_test",
              "value": "={{ $json.is_test }}",
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5728,
        784
      ],
      "id": "2531f2c8-c75a-45b8-ab34-ef364a786613",
      "name": "Client Metadata"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "18afb9f1-76e3-448f-a4e0-99df188d3a01",
              "leftValue": "={{ $('Client Metadata').first().json.is_group }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4928,
        880
      ],
      "id": "88b41f26-d4b1-4442-a6ed-6e5207bffe07",
      "name": "Is Group Message?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7e340b68-a0fb-430f-8b11-2dc0a7722bdf",
              "leftValue": "={{ $json.phone_number }}",
              "rightValue": "380963236071",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5712,
        912
      ],
      "id": "eb906fd5-eb68-4d1d-8c6e-fad88ebe9546",
      "name": "TESTING_IF",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## FOR TEST",
        "height": 384,
        "width": 256
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5776,
        688
      ],
      "typeVersion": 1,
      "id": "e8a456a9-af70-4098-8d2e-e8bdb0e6bff1",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('ENV Variables').first().json.wasender_api_key }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"to\": \"{{ $('Client Data').first().json.phone_number }}\", \n  \"text\": {{ JSON.stringify($json.message) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        1088
      ],
      "id": "272f3659-8373-4fc7-abb4-69cbda880e09",
      "name": "Send WasenderApi Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.wassenger.com/v1/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Token",
              "value": "5b6a656367492cf458c91ca0ba88b125409419fa4a956848528326a64d268c00b5647ccbb851986c"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"group\": \"{{ $('ENV Variables').first().json.manager_group_id }}\",\n  \"message\": {{ JSON.stringify($json.message) }}\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        896,
        240
      ],
      "id": "08445b89-490a-4055-b74b-f32d8a280653",
      "name": "Send Qualified Client Message3"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={  \n  \"to\": \"{{ $('ENV Variables').first().json.manager_group_id }}\",   \n  \"text\": {{ JSON.stringify($json.message) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -16,
        1152
      ],
      "id": "56dcc994-9bf1-4d9a-92b3-76460d4c00be",
      "name": "Send WasenderApi Message1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "MAm1jDZG5pRhtI6A",
          "name": "kristina_dubai_WassenderAPI_auth"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -5232,
        1552
      ],
      "id": "8621bcd5-afc2-4c67-a3ad-797e670109df",
      "name": "Ignore Group Message"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "596962d1-2480-434f-a8db-bf622498668f",
              "leftValue": "={{ $('Client Metadata').first().json.group_id}}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "2043d51a-4a74-4e14-86b6-125379952ffd",
              "leftValue": "={{ $('Client Metadata').first().json.group_id}}",
              "rightValue": "={{ $('ENV Variables').first().json.manager_group_id }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5456,
        1424
      ],
      "id": "9531b83a-373a-413b-8612-43d4e1a016dc",
      "name": "Is stop list request?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('ENV Variables').first().json.supabase_clients_url + '?on_conflict=phone_number' }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={{ JSON.stringify($json.numbers.map(n => ({ phone_number: n, qualification_done: true }))) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4800,
        1296
      ],
      "id": "8d1ac772-8af5-4fba-8d65-ef56301ebb95",
      "name": "Upsert Clients",
      "credentials": {
        "httpHeaderAuth": {
          "id": "FAFnBfYyqTLXDpjY",
          "name": "Kristina Dubai Supabase Auth Account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "const stopNumbersStr = $('Client Metadata').first().json.message\n\nconst numbers = stopNumbersStr\n  .split(\",\")\n  .map(s => s.normalize(\"NFKD\"))     // normalize Unicode\n  .map(s => s.replace(/[^\\d+]/g, \"\")) // leave only digits and +\n  .map(s => s.replace(/^\\+/, \"\"))    // remove + in the beginning\n  .filter(s => !!s)\n\nreturn [\n    { \n      json: { \n        numbers: numbers\n      } \n    }\n  ]\n// [\"971581829763\", \"366168609763\", \"12158565163\"]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5232,
        1296
      ],
      "id": "bc9e4683-13d9-461d-9e48-3c78d0967dd5",
      "name": "Get Array of Numbers"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={  \"to\": \"{{ $('ENV Variables').first().json.manager_group_id }}\",   \"text\": \"{{ `Successfully added to stop list: ${$('Get Array of Numbers').first().json.numbers.join(', ')}`}}\"}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4400,
        1216
      ],
      "id": "d4dc9a01-4b10-45c5-92f4-ea8c77fe6165",
      "name": "Send Stop List Success Message",
      "credentials": {
        "httpHeaderAuth": {
          "id": "MAm1jDZG5pRhtI6A",
          "name": "kristina_dubai_WassenderAPI_auth"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "{|  \"to\": \"120363404444968121@g.us\",   \"text\": \"FAILED to add numbers to stop list\"}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -4576,
        1376
      ],
      "id": "3f573545-6a2e-428b-9704-c28fe2c5da6f",
      "name": "Send Stop List Error Message",
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -4576,
        1216
      ],
      "id": "50c114cf-4553-48bb-b8c3-2dac19e398f4",
      "name": "Wait 5 seconds",
      "webhookId": "f2daa8ae-bcf9-48e1-8e4c-2d0dc5a56bbc"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "22e978f2-6f1a-46bc-a37d-0a2bbf6b5884",
              "leftValue": "={{ $json.numbers }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5024,
        1296
      ],
      "id": "73ca5e81-e12c-4fde-a0f3-3143aa50bf46",
      "name": "If"
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        1152
      ],
      "id": "cbf0c983-ee44-4aa0-a403-1d0e5a93d00f",
      "name": "Wait1",
      "webhookId": "018cbb10-32c2-4d4a-8830-7ba31a3c90e8"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        976
      ],
      "id": "e6fa2d01-5b05-44ce-8097-ca3dea5947e5",
      "name": "Wait2",
      "webhookId": "5239f246-6760-470b-af60-0b38914728c5"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c9f6b181-02ae-4382-bd69-a677eeded558",
              "leftValue": "={{ $('Parse to JSON').first().json.state_user_role }}",
              "rightValue": "Agent",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -576,
        976
      ],
      "id": "5004a3e0-5500-47d4-ace2-ee068d4cb792",
      "name": "Is Agent?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "698e79c1-c99d-4b13-9b99-c03146d8a31b",
              "name": "agent_message",
              "value": "*Emaar Beachfront*\nReady apartments with 2 years post-handover payment plan \n â€¢ 1 BDR â€“ from 2.65M\n â€¢ 2 BDR â€“ 4M\n â€¢ 3 BDR â€“ 7.2M\nðŸ‘‰ https://drive.google.com/drive/mobile/folders/1F810_mr2AXBrysub0yiZi-OJuTXr7Ti6?usp=sharing \n\n\nðŸ”¥ *Palace Beach Residences*\n3 BDR, fully renovated - 9.3M\n\nðŸ‘‰ PHOTO https://strvkr.wixsite.com/palace3\nðŸ‘‰ VIDEO https://vimeo.com/1112575824",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -192,
        976
      ],
      "id": "3662d937-b3a6-4b9a-8344-4aab19054237",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "test_ai",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -7024,
        688
      ],
      "id": "8b382dce-559c-4f85-89ea-5c443ada0d45",
      "name": "WasenderAPI Test Message",
      "webhookId": "167afffd-d587-4d85-84a2-5e7b7c39360c",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('ENV Variables').first().json.wasender_api_key }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"to\": \"{{ $('Client Data').first().json.phone_number }}\", \n  \"text\": {{ JSON.stringify($json.message) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -960,
        512
      ],
      "id": "3e4d6a2a-e6a0-422f-82d7-19ecfc7186a3",
      "name": "Send WasenderApi Test Message"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"to\": \"{{ $('Client Data').first().json.phone_number }}\", \n  \"text\": {{ JSON.stringify($json.agent_message) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -16,
        976
      ],
      "id": "a48a7a53-1a1d-429f-bc2a-97781d3b3606",
      "name": "Send Followup Agent Message",
      "credentials": {
        "httpHeaderAuth": {
          "id": "MAm1jDZG5pRhtI6A",
          "name": "kristina_dubai_WassenderAPI_auth"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://fybqwzsdoqcucdtxhlla.supabase.co/rest/v1/clients?on_conflict=phone_number\n",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "=[{\n  \"phone_number\":\"380963236071\",\n  {{ (true ? '\"qualification_done\": true' : '') }}\n}]\n",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -5072,
        1568
      ],
      "id": "58f563c7-f7c4-4edc-af48-7e200cea3629",
      "name": "Upsert Clients1",
      "credentials": {
        "httpHeaderAuth": {
          "id": "FAFnBfYyqTLXDpjY",
          "name": "Kristina Dubai Supabase Auth Account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.body.data.messages.message.conversation ?? $json.body.data.messages.message.extendedTextMessage.text }}",
                    "rightValue": "",
                    "operator": {
                      "type": "string",
                      "operation": "notEmpty",
                      "singleValue": true
                    },
                    "id": "8faa9523-8152-41d5-9193-a5b92faac672"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "2ba06127-6b9a-4b18-94db-115b67901eb6",
                    "leftValue": "={{ $json.body.data.messages.message.audioMessage }}",
                    "rightValue": "",
                    "operator": {
                      "type": "object",
                      "operation": "exists",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Audio"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -6432,
        768
      ],
      "id": "32e10f69-47e0-4fa2-8032-d65ce68c85e9",
      "name": "Type"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1eaca9c5-dde0-4a95-8ba6-855ddb789dcd",
              "name": "text",
              "value": "={{ $json.body.data.messages.message.conversation ?? $json.body.data.messages.message.extendedTextMessage.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6160,
        688
      ],
      "id": "d7a1a714-269e-4705-811f-feb6a8dd4a36",
      "name": "Text"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "Fv9rE9Unty56aL2x",
          "mode": "list",
          "cachedResultName": "HandleAudioMessage"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "body_data_messages_message_audioMessage_fileLength_firstItem": "={{ $json.body.data.messages.message.audioMessage.fileLength }}",
            "body_data_messages_message_audioMessage_fileEncSha256_firstItem": "={{ $json.body.data.messages.message.audioMessage.fileEncSha256 }}",
            "body_data_messages_message_audioMessage_mimetype": "={{ $json.body.data.messages.message.audioMessage.mimetype }}",
            "body_data_messages_message_audioMessage_mediaKey_firstItem": "={{ $json.body.data.messages.message.audioMessage.mediaKey }}",
            "body_data_messages_message_audioMessage_url_firstItem": "={{ $json.body.data.messages.message.audioMessage.url }}",
            "body_data_messages_key_id_firstItem": "={{ $json.body.data.messages.key.id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "body_data_messages_key_id_firstItem",
              "displayName": "body_data_messages_key_id_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "body_data_messages_message_audioMessage_url_firstItem",
              "displayName": "body_data_messages_message_audioMessage_url_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "body_data_messages_message_audioMessage_mediaKey_firstItem",
              "displayName": "body_data_messages_message_audioMessage_mediaKey_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "body_data_messages_message_audioMessage_mimetype",
              "displayName": "body_data_messages_message_audioMessage_mimetype",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "body_data_messages_message_audioMessage_fileEncSha256_firstItem",
              "displayName": "body_data_messages_message_audioMessage_fileEncSha256_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "body_data_messages_message_audioMessage_fileLength_firstItem",
              "displayName": "body_data_messages_message_audioMessage_fileLength_firstItem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -6160,
        880
      ],
      "id": "a5476901-88c0-4d29-933d-b89a22b398ce",
      "name": "HandleAudioMessage"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -6816,
        784
      ],
      "id": "b63b5cf3-f6df-4c57-9158-ba74287a7c91",
      "name": "Message"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Client Data').first().json.phone_number }}",
        "tableName": "kristina_dubai_chat_histories",
        "contextWindowLength": 15
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -1936,
        1040
      ],
      "id": "f65a2223-09fc-4a04-8b04-0949431e16c5",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "dbUvQyOOeDxRzHfe",
          "name": "ClientRecords"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Extract and parse only the required keys from the JSON string in 'output'\nreturn items.map(item => {\n  const parsed = JSON.parse(item.json.output);\n\n  return {\n    json: {\n      message: parsed.message,\n      qualification_done: parsed.qualification_done,\n      summary: parsed.summary,\n      off_topic_redirect: parsed.off_topic_redirect,\n      \n      // Nested structure flattened for convenience\n      state_user_role: parsed.state?.user_role,\n      state_building_familiarity: parsed.state?.building_familiarity,\n      state_payment_method: parsed.state?.payment_method,\n      state_pre_approved: parsed.state?.pre_approved,\n      state_client_intent: parsed.state?.client_intent,\n      state_off_topic_count: parsed.state?.off_topic_count\n    }\n  }\n});\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1680,
        800
      ],
      "id": "3f446d40-d9d3-4f85-ac17-7c41a9be3908",
      "name": "Parse to JSON",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "0312def6-af7b-49a7-bf78-0ba01ca99b5e",
              "leftValue": "={{ $('Parse to JSON').first().json.qualification_done }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -784,
        528
      ],
      "id": "d4f36827-9ab2-4c72-b327-cf01a1a579f3",
      "name": "Client Qualified1"
    },
    {
      "parameters": {
        "jsCode": "const formatForWhatsApp = (\n  {\n    state_user_role, \n    state_payment_method, \n    state_building_familiarity, \n    state_client_intent, \n    summary\n  }, \n  phone_number\n) => {\n  return `1. *Client Type*: ${capitalize(state_user_role)}\\n` +\n         `2. *Payment*: ${capitalize(state_payment_method)}\\n` +\n         `3. *Knows The Property*: ${capitalizeYesNo(state_building_familiarity)}\\n` +\n         `4. *Intent*: ${capitalize(state_client_intent)}\\n` +\n         `5. *Summary*: ${summary}\\n` +\n         `6. *Chat*: https://wa.me/${phone_number}`\n}\n\nconst capitalize = str => !str ? 'â€”' : str.charAt(0).toUpperCase() + str.slice(1)\nconst capitalizeYesNo = str => str === 'Yes' ? 'Yes' : str === 'No' ? 'No' : capitalize(str)\n\nconst ai = $('Parse to JSON').first().json\nconst phone = $('Client Data').first().json.phone_number\n\nconst message = formatForWhatsApp(ai, phone)\n\nreturn [{ message }]\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -576,
        608
      ],
      "id": "40816308-15cd-4daf-98b2-6ded77087556",
      "name": "Create Qualification Message1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('ENV Variables').first().json.wasender_api_key }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={  \n  \"to\": \"120363422005783387@g.us\",   \n  \"text\": {{ JSON.stringify($json.message) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -16,
        608
      ],
      "id": "f0d5b795-3d92-4cb1-bcf4-dbc5769f09f0",
      "name": "Send WasenderApi Message2"
    },
    {
      "parameters": {
        "amount": 10
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        608
      ],
      "id": "03f75e61-dc6a-4c38-86cd-6c6f23e47872",
      "name": "Wait3",
      "webhookId": "4a1f46c3-9962-459a-a3e3-ee71367fac44"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        -368,
        432
      ],
      "id": "3f4d6a45-43de-4388-bdda-894a7b37cdae",
      "name": "Wait4",
      "webhookId": "8b8f2299-eea8-4780-b030-010a88097a0b"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "c9f6b181-02ae-4382-bd69-a677eeded558",
              "leftValue": "={{ $('Parse to JSON').first().json.state_user_role }}",
              "rightValue": "Agent",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -576,
        432
      ],
      "id": "5b7e8741-5d19-4a2b-b6b9-8068fd3999b6",
      "name": "Is Agent?1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "698e79c1-c99d-4b13-9b99-c03146d8a31b",
              "name": "agent_message",
              "value": "*Fully customizable follow-up message*\nReady apartments with 2 years post-handover payment plan \n â€¢ 1 BDR â€“ from 2M\n â€¢ 2 BDR â€“ 3M\n â€¢ 3 BDR â€“ 4M\nðŸ‘‰ https://example-link.com\n\nðŸ‘‰ PHOTO https://example-link.com\nðŸ‘‰ VIDEO https://example-link.com",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -192,
        432
      ],
      "id": "3f7d7b3d-39c2-46ae-ab59-b31908711285",
      "name": "Edit Fields2"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://wasenderapi.com/api/send-message",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{ $('ENV Variables').first().json.wasender_api_key }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "raw",
        "rawContentType": "application/json",
        "body": "={\n  \"to\": \"{{ $('Client Data').first().json.phone_number }}\", \n  \"text\": {{ JSON.stringify($json.agent_message) }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -16,
        432
      ],
      "id": "7cfdde6d-a4a6-4787-aed8-58361f8c56fc",
      "name": "Send Followup Agent Message1"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -784,
        688
      ],
      "id": "486e883d-c702-4ec9-9c12-0664f19f836c",
      "name": "No Operation, do nothing"
    }
  ],
  "pinData": {
    "Message Received": [
      {
        "json": {
          "headers": {
            "host": "redstone123.app.n8n.cloud",
            "user-agent": "wa-api-webhook",
            "content-length": "3340",
            "accept-encoding": "gzip, br",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "34.16.170.133",
            "cf-ew-via": "15",
            "cf-ipcountry": "US",
            "cf-ray": "974e2352073f1ef2-LHR",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "content-type": "application/json; charset=utf-8",
            "idempotency-key": "3FFE738AC7BEB6233F99",
            "x-forwarded-for": "34.16.170.133, 162.158.216.149",
            "x-forwarded-host": "redstone123.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-45-5cf4858c8f-sczzn",
            "x-is-trusted": "yes",
            "x-real-ip": "34.16.170.133"
          },
          "params": {},
          "query": {},
          "body": {
            "id": "3FFE738AC7BEB6233F99",
            "object": "message",
            "event": "message:in:new",
            "created": 1756156873,
            "device": {
              "id": "6894781043481610f9a9e941",
              "phone": "+971569901723",
              "alias": "Kristina",
              "plan": "io-professional"
            },
            "data": {
              "id": "3FFE738AC7BEB6233F99",
              "type": "text",
              "flow": "inbound",
              "status": "active",
              "ack": "delivered",
              "from": "120363419887584150@g.us",
              "fromNumber": "+380963236071",
              "to": "971569901723@c.us",
              "toNumber": "+971569901723",
              "date": "2025-08-25T21:21:13.000Z",
              "timestamp": 1756156873,
              "body": "998934621498, â€ª+99 8934621Â 499â€¬",
              "author": "380963236071@c.us",
              "chat": {
                "id": "120363419887584150@g.us",
                "name": "Qualified Clients",
                "date": "2025-08-25T21:19:24.000Z",
                "type": "group",
                "status": "pending",
                "waStatus": "archived",
                "statusUpdatedAt": "2025-08-25T21:19:25.264Z",
                "statusUpdatedBy": null,
                "prevStatus": "pending",
                "prevStatusUpdatedAt": "2025-08-08T07:43:17.863Z",
                "archivedAt": "2025-08-22T11:06:20.278Z",
                "firstMessageAt": "2025-08-07T18:57:35.000Z",
                "lastMessageAt": "2025-08-25T21:21:13.000Z",
                "lastMessageTime": 1756156873,
                "lastOutboundMessageAt": "2025-08-25T20:33:06.000Z",
                "lastInboundMessageAt": "2025-08-25T21:21:13.000Z",
                "lastReactionAt": "2025-08-08T06:04:30.553Z",
                "lastReactionEmoji": "ðŸ‘",
                "lastReactionAuthor": "267645819596960@lid",
                "lastAutoReply": null,
                "lastAutoReplyAt": null,
                "stats": {
                  "inboundMessages": 0,
                  "localMessages": 98,
                  "notes": 0,
                  "outboundMessages": 0
                },
                "labels": [],
                "owner": {
                  "agent": null,
                  "department": null,
                  "previousDepartment": null,
                  "departmentAssigner": null,
                  "departmentUpdatedAt": null,
                  "autoAssignDepartment": null,
                  "autoAssignDepartmentAt": null
                },
                "contact": {
                  "wid": "120363419887584150@g.us",
                  "type": "group",
                  "name": "Qualified Clients",
                  "syncedAt": "2025-08-07T18:43:00.694Z",
                  "groupId": "120363419887584150",
                  "info": {
                    "languages": [],
                    "links": [],
                    "fullName": null
                  },
                  "locationInfo": {},
                  "metadata": [],
                  "campaigns": [],
                  "subscription": {
                    "status": "active",
                    "updatedAt": "2025-08-07T18:43:00.694Z"
                  }
                },
                "group": {
                  "date": "2025-08-07T18:38:05.000Z",
                  "owner": "380963236071@c.us",
                  "community": null,
                  "isCommunityAnnounce": false,
                  "announce": false,
                  "restrict": false,
                  "membershipApproval": false,
                  "membershipInvite": true,
                  "totalParticipants": 3
                },
                "links": {
                  "chat": "/v1/chat/6894781043481610f9a9e941/chats/120363419887584150@g.us",
                  "messages": "/v1/chat/6894781043481610f9a9e941/messages?chat=120363419887584150@g.us",
                  "status": "/v1/chat/6894781043481610f9a9e941/status?chat=120363419887584150@g.us",
                  "contact": "/v1/chat/6894781043481610f9a9e941/contacts/120363419887584150@g.us",
                  "device": "/v1/devices/6894781043481610f9a9e941",
                  "participants": "/v1/chat/6894781043481610f9a9e941/chats/120363419887584150@g.us/participants"
                }
              },
              "events": {},
              "meta": {
                "containsEmoji": false,
                "isBizNotification": false,
                "isBroadcast": false,
                "isChannel": false,
                "isDoc": false,
                "isEphemeral": false,
                "isFailed": false,
                "isForwarded": false,
                "isGif": false,
                "isGroup": true,
                "isLinkPreview": false,
                "isLive": false,
                "isNotification": false,
                "isPSA": false,
                "isRevoked": false,
                "isStar": false,
                "isUnreadType": false,
                "notifyName": "Maksym",
                "rtl": false,
                "source": "web",
                "isFirstMessage": false
              },
              "links": {
                "message": "/v1/chat/6894781043481610f9a9e941/messages/3FFE738AC7BEB6233F99",
                "chat": "/v1/chat/6894781043481610f9a9e941/chats/120363419887584150@g.us",
                "contact": "/v1/chat/6894781043481610f9a9e941/contacts/120363419887584150@g.us",
                "chatMessages": "/v1/chat/6894781043481610f9a9e941/messages?chat=120363419887584150@g.us",
                "device": "/v1/devices/6894781043481610f9a9e941"
              }
            }
          },
          "webhookUrl": "https://redstone123.app.n8n.cloud/webhook/whatsapp-in",
          "executionMode": "production"
        }
      }
    ],
    "Gupsup Message": [
      {
        "json": {
          "headers": {
            "host": "redstone123.app.n8n.cloud",
            "user-agent": "okhttp/4.12.0",
            "content-length": "556",
            "accept-encoding": "gzip, br",
            "cdn-loop": "cloudflare; loops=1; subreqs=1",
            "cf-connecting-ip": "52.66.99.126",
            "cf-ew-via": "15",
            "cf-ipcountry": "IN",
            "cf-ray": "97565af1f07cf15a-BOM",
            "cf-visitor": "{\"scheme\":\"https\"}",
            "cf-worker": "n8n.cloud",
            "content-type": "application/json; charset=utf-8",
            "x-forwarded-for": "52.66.99.126, 172.70.218.200",
            "x-forwarded-host": "redstone123.app.n8n.cloud",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "traefik-prod-users-gwc-45-5cf4858c8f-cl65b",
            "x-is-trusted": "yes",
            "x-real-ip": "52.66.99.126"
          },
          "params": {},
          "query": {},
          "body": {
            "entry": [
              {
                "changes": [
                  {
                    "field": "messages",
                    "value": {
                      "contacts": [
                        {
                          "profile": {
                            "name": "Maksym"
                          },
                          "wa_id": "380963236071"
                        }
                      ],
                      "messages": [
                        {
                          "from": "380963236071",
                          "id": "wamid.HBgMMzgwOTYzMjM2MDcxFQIAEhggMjg5RkE3NDA0NkExNTdFNTE4MDI5OEQ5Qjk2RkIxMzYA",
                          "text": {
                            "body": "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ"
                          },
                          "timestamp": "1756243037",
                          "type": "text"
                        }
                      ],
                      "messaging_product": "whatsapp",
                      "metadata": {
                        "display_phone_number": "94743353842",
                        "phone_number_id": "768586436332705"
                      }
                    }
                  }
                ],
                "id": "2291962534532339"
              }
            ],
            "gs_app_id": "3ffbd417-3be1-4fbe-b1ae-949c233e4333",
            "object": "whatsapp_business_account"
          },
          "webhookUrl": "https://redstone123.app.n8n.cloud/webhook/7bea28e7-a91a-4198-a0eb-0caef77aefb8",
          "executionMode": "production"
        }
      }
    ],
    "WasenderAPI Test Message": [
      {
        "json": {
          "headers": {
            "host": "n8n.orbitalgarden.space",
            "user-agent": "axios/1.12.2",
            "content-length": "875",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "via": "1.1 Caddy",
            "x-forwarded-for": "69.62.66.76",
            "x-forwarded-host": "n8n.orbitalgarden.space",
            "x-forwarded-proto": "https",
            "x-webhook-signature": "da6607be0a9be6e9e055cffa5df103dc"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.received",
            "sessionId": "a1ce08457c8ae054d4ff2849f61141ad3af71639a1663825a5fa1bb4c7bd3a0a",
            "data": {
              "messages": {
                "key": {
                  "remoteJid": "380963236071@s.whatsapp.net",
                  "fromMe": false,
                  "id": "ACBC8085CD9ECC145241D23BC2DB5DB4",
                  "senderLid": "223690990071920@lid",
                  "senderPn": "380963236071@s.whatsapp.net",
                  "cleanedSenderPn": "380963236071",
                  "addressingMode": "pn"
                },
                "messageTimestamp": 1761835989,
                "pushName": "Maksym",
                "broadcast": false,
                "message": {
                  "conversation": "Hello",
                  "messageContextInfo": {
                    "deviceListMetadata": {
                      "senderKeyHash": "80uKoW6Lf5mNGg==",
                      "senderTimestamp": "1760980763",
                      "recipientKeyHash": "tVv6tD32kLoHTA==",
                      "recipientTimestamp": "1760517344"
                    },
                    "deviceListMetadataVersion": 2,
                    "messageSecret": "xWIH8qT8E1dF/ZQuiDXg6VuL5IVIzD4jVl451BemP9s="
                  }
                },
                "messageBody": "Hello",
                "remoteJid": "380963236071@s.whatsapp.net",
                "id": "ACBC8085CD9ECC145241D23BC2DB5DB4"
              }
            },
            "timestamp": 1761835989880
          },
          "webhookUrl": "https://n8n.orbitalgarden.space/webhook/test_ai",
          "executionMode": "production"
        }
      }
    ],
    "WasenderAPI Message": [
      {
        "json": {
          "headers": {
            "host": "n8n.orbitalgarden.space",
            "user-agent": "axios/1.12.2",
            "content-length": "1013",
            "accept": "application/json, text/plain, */*",
            "accept-encoding": "gzip, compress, deflate, br",
            "content-type": "application/json",
            "via": "1.1 Caddy",
            "x-forwarded-for": "82.25.92.152",
            "x-forwarded-host": "n8n.orbitalgarden.space",
            "x-forwarded-proto": "https",
            "x-webhook-signature": "08139d3542aba3cba134211058ea6a6f"
          },
          "params": {},
          "query": {},
          "body": {
            "event": "messages.received",
            "sessionId": "31f80b7c5666626556ae8960357445868e2bc15b8530c964663e7cf8565e618c",
            "data": {
              "messages": {
                "key": {
                  "id": "2A10181E59C986D11F76",
                  "fromMe": false,
                  "remoteJid": "971565500570@s.whatsapp.net",
                  "senderPn": "971565500570@s.whatsapp.net",
                  "cleanedSenderPn": "971565500570",
                  "senderLid": "93811111923925@lid",
                  "addressingMode": "pn"
                },
                "messageTimestamp": 1764054338,
                "pushName": "Rabiya Bukhari",
                "broadcast": false,
                "message": {
                  "conversation": "It can be for both purposes for rental and investment purpose too",
                  "messageContextInfo": {
                    "deviceListMetadata": {
                      "senderKeyHash": "6/6QVeudRDTAgw==",
                      "senderTimestamp": "1763110474",
                      "recipientKeyHash": "9aHRR9sJZDtlag==",
                      "recipientTimestamp": "1763891586"
                    },
                    "deviceListMetadataVersion": 2,
                    "messageSecret": "BThsNQNKZjYe0xDDTp9kqfBkZismoLjrGZ2OT9qBJgs="
                  }
                },
                "verifiedBizName": "Rabiya Bukhari",
                "messageBody": "It can be for both purposes for rental and investment purpose too",
                "remoteJid": "971565500570@s.whatsapp.net",
                "id": "2A10181E59C986D11F76"
              }
            },
            "timestamp": 1764054338360
          },
          "webhookUrl": "https://n8n.orbitalgarden.space/webhook/kristina_dubai",
          "executionMode": "production"
        }
      }
    ]
  },
  "connections": {
    "OpenAI1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Client Qualified": {
      "main": [
        [
          {
            "node": "Create Qualification Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Agent?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Client": {
      "main": [
        [
          {
            "node": "Check Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Client": {
      "main": [
        [
          {
            "node": "Create Client",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Client Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Client Is Already Qualified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Client": {
      "main": [
        [
          {
            "node": "Client Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Client Data": {
      "main": [
        [
          {
            "node": "Add to Messages Stack",
            "type": "main",
            "index": 0
          },
          {
            "node": "Wait 100 seconds",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Latest Message Stack": {
      "main": [
        [
          {
            "node": "Should Continue?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Continue?": {
      "main": [
        [
          {
            "node": "Get Messages Buffer",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Client sent another message, stop execution",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid?": {
      "main": [
        [
          {
            "node": "Get Client",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Invalid input data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Messages Buffer": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Qualification Message": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Parse to JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ENV Variables": {
      "main": [
        [
          {
            "node": "Is Test?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Test?": {
      "main": [
        [
          {
            "node": "Get Client",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Is Group Message?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Test?1": {
      "main": [
        [
          {
            "node": "Send WasenderApi Test Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send WasenderApi Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prod test If": {
      "main": [
        [
          {
            "node": "Prod test If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Output Not Empty?": {
      "main": [
        [
          {
            "node": "Is Test?1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Update Client",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 100 seconds": {
      "main": [
        [
          {
            "node": "Get Latest Message Stack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid Gupshup Message?": {
      "main": [
        [
          {
            "node": "Gupshup Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gupsup Message": {
      "main": [
        [
          {
            "node": "Valid Gupshup Message?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid Wassenger Message?": {
      "main": [
        [
          {
            "node": "Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WasenderAPI Message": {
      "main": [
        [
          {
            "node": "Message",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Wassenger Metadata": {
      "main": [
        [
          {
            "node": "Client Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Client Metadata": {
      "main": [
        [
          {
            "node": "ENV Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Group Message?": {
      "main": [
        [
          {
            "node": "Is stop list request?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send WasenderApi Message": {
      "main": [
        [
          {
            "node": "Client Qualified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is stop list request?": {
      "main": [
        [
          {
            "node": "Get Array of Numbers",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ignore Group Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Clients": {
      "main": [
        [
          {
            "node": "Wait 5 seconds",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Stop List Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Array of Numbers": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait 5 seconds": {
      "main": [
        [
          {
            "node": "Send Stop List Success Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Upsert Clients",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Send WasenderApi Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait2": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Agent?": {
      "main": [
        [
          {
            "node": "Wait2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Send Followup Agent Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WasenderAPI Test Message": {
      "main": [
        [
          {
            "node": "Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Type": {
      "main": [
        [
          {
            "node": "Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "HandleAudioMessage",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HandleAudioMessage": {
      "main": [
        [
          {
            "node": "Wassenger Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Text": {
      "main": [
        [
          {
            "node": "Wassenger Metadata",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Message": {
      "main": [
        [
          {
            "node": "Valid Wassenger Message?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Parse to JSON": {
      "main": [
        [
          {
            "node": "Output Not Empty?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Client Qualified1": {
      "main": [
        [
          {
            "node": "Is Agent?1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create Qualification Message1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Qualification Message1": {
      "main": [
        [
          {
            "node": "Wait3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait3": {
      "main": [
        [
          {
            "node": "Send WasenderApi Message2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait4": {
      "main": [
        [
          {
            "node": "Edit Fields2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Agent?1": {
      "main": [
        [
          {
            "node": "Wait4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields2": {
      "main": [
        [
          {
            "node": "Send Followup Agent Message1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send WasenderApi Test Message": {
      "main": [
        [
          {
            "node": "Client Qualified1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f109712f-73a7-431a-b538-2331a99d2f03",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "c9e53a150db3979558dce85b88732650eafd440e09b4690afc30683da1136ad9"
  },
  "id": "2H4JCsV0zge66tTv",
  "tags": [
    {
      "updatedAt": "2025-09-14T12:25:31.358Z",
      "createdAt": "2025-09-14T12:25:31.358Z",
      "id": "oi3mfeDHd8seIZYf",
      "name": "latest"
    }
  ]
}